{% extends 'base.html' %}
{% load static %}
{% block title %}Webcam Scan â€” EyeDetect AI{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <div class="page-breadcrumb">
      <a href="{% url 'home' %}">Home</a> / <span>Webcam Scan</span>
    </div>
    <h1 class="page-title">ğŸ“· Live Webcam Scan</h1>
    <p class="page-sub">Capture an eye photo using your device's camera for instant AI analysis.</p>
  </div>
</div>

<div class="container webcam-container">
  <div class="webcam-layout">

    <!-- Camera Feed -->
    <div class="webcam-card">
      <div class="webcam-viewport" id="webcamViewport">
        <video id="webcamVideo" autoplay playsinline></video>
        <canvas id="webcamCanvas" class="hidden"></canvas>
        <div class="webcam-overlay">
          <div class="webcam-guide-ring"></div>
          <span class="webcam-guide-text">Position eye in circle</span>
        </div>
        <div class="webcam-start-prompt" id="webcamPrompt">
          <div class="cam-icon">ğŸ“·</div>
          <p>Click "Start Camera" to begin</p>
        </div>
      </div>

      <div class="webcam-controls">
        <button class="btn-primary" id="startCamBtn">â–¶ Start Camera</button>
        <button class="btn-primary hidden" id="captureBtn">ğŸ“¸ Capture</button>
        <button class="btn-ghost hidden" id="retakeBtn">ğŸ”„ Retake</button>
        <button class="btn-ghost" id="stopCamBtn" style="display:none">â¹ Stop</button>
      </div>
    </div>

    <!-- Result Panel -->
    <div class="webcam-result-panel" id="resultPanel">
      <div class="result-idle" id="resultIdle">
        <div class="idle-icon">ğŸ”¬</div>
        <h3>Ready to Scan</h3>
        <p>Start the camera, position the eye, and capture to get an instant AI result.</p>
        <div class="webcam-tips">
          <p>ğŸ’¡ Tips for best results:</p>
          <ul>
            <li>Ensure good lighting</li>
            <li>Hold camera 15-30cm away</li>
            <li>Keep eye still during capture</li>
            <li>Use high-res front camera</li>
          </ul>
        </div>
      </div>

      <div class="result-loading hidden" id="resultLoading">
        <div class="spinner"></div>
        <h3>Analyzing...</h3>
        <p>AI is processing the eye image</p>
      </div>

      <div class="result-output hidden" id="resultOutput">
        <div id="resultEmoji" class="result-big-emoji">â“</div>
        <div id="resultLabel" class="result-label-text">â€”</div>
        <div id="resultDisease" class="result-disease-text">â€”</div>
        <div id="resultConf" class="result-conf-text">â€”</div>
        <div id="resultSeverity" class="result-sev-text">â€”</div>
        <div class="webcam-prob-bars" id="probBars"></div>
        <div class="webcam-actions">
          <a id="fullResultLink" href="#" class="btn-primary" style="display:none">
            ğŸ“„ Full Report
          </a>
          <button class="btn-ghost" id="retakeBtn2">ğŸ“· Scan Again</button>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const video = document.getElementById('webcamVideo');
const canvas = document.getElementById('webcamCanvas');
const startBtn = document.getElementById('startCamBtn');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const retakeBtn2 = document.getElementById('retakeBtn2');
const stopBtn = document.getElementById('stopCamBtn');
const prompt_ = document.getElementById('webcamPrompt');
const resultIdle = document.getElementById('resultIdle');
const resultLoading = document.getElementById('resultLoading');
const resultOutput = document.getElementById('resultOutput');

let stream = null;
const DISEASE_EMOJIS = {
  cataract: 'ğŸ˜¶', diabetic_retinopathy: 'ğŸ©¸', glaucoma: 'ğŸ’§', normal: 'âœ…'
};

startBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    video.srcObject = stream;
    prompt_.style.display = 'none';
    startBtn.classList.add('hidden');
    captureBtn.classList.remove('hidden');
    stopBtn.style.display = 'inline-flex';
  } catch (e) {
    alert('Camera access denied. Please allow camera permission and try again.');
  }
});

captureBtn.addEventListener('click', () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  captureBtn.classList.add('hidden');
  retakeBtn.classList.remove('hidden');
  showLoading();
  canvas.toBlob(blob => sendToAPI(blob), 'image/jpeg', 0.92);
});

function retake() {
  retakeBtn.classList.add('hidden');
  captureBtn.classList.remove('hidden');
  resultLoading.classList.add('hidden');
  resultOutput.classList.add('hidden');
  resultIdle.classList.remove('hidden');
}
retakeBtn.addEventListener('click', retake);
retakeBtn2.addEventListener('click', retake);

stopBtn.addEventListener('click', () => {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  startBtn.classList.remove('hidden');
  captureBtn.classList.add('hidden');
  retakeBtn.classList.add('hidden');
  stopBtn.style.display = 'none';
  prompt_.style.display = 'flex';
});

function showLoading() {
  resultIdle.classList.add('hidden');
  resultOutput.classList.add('hidden');
  resultLoading.classList.remove('hidden');
}

async function sendToAPI(blob) {
  const form = new FormData();
  form.append('image', blob, 'webcam.jpg');
  try {
    const resp = await fetch("{% url 'webcam_predict' %}", { method: 'POST', body: form });
    const data = await resp.json();
    showResult(data);
  } catch (e) {
    resultLoading.classList.add('hidden');
    resultIdle.classList.remove('hidden');
    alert('Analysis failed. Please try again.');
  }
}

function showResult(data) {
  resultLoading.classList.add('hidden');
  resultOutput.classList.remove('hidden');

  document.getElementById('resultEmoji').textContent = DISEASE_EMOJIS[data.disease] || 'â“';
  document.getElementById('resultLabel').textContent = 'DETECTED CONDITION';
  document.getElementById('resultDisease').textContent = data.disease_name;
  document.getElementById('resultConf').textContent = `${data.confidence}% Confidence`;
  document.getElementById('resultSeverity').textContent = `Severity: ${data.severity}`;
  document.getElementById('resultSeverity').className = `result-sev-text sev-${data.severity}`;

  // Probability bars
  const bars = document.getElementById('probBars');
  bars.innerHTML = '';
  if (data.all_probs) {
    Object.entries(data.all_probs).forEach(([d, p]) => {
      bars.innerHTML += `
        <div class="prob-bar-row">
          <span class="prob-label">${d.replace('_',' ')}</span>
          <div class="prob-track"><div class="prob-fill prob-${d}" style="width:${p}%"></div></div>
          <span class="prob-value">${p}%</span>
        </div>`;
    });
  }
}
</script>
{% endblock %}
