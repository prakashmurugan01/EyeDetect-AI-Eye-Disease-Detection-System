{% extends 'base.html' %}
{% load static %}
{% block title %}Dr. Bot â€” Eye Health Assistant{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <div class="page-breadcrumb">
      <a href="{% url 'home' %}">Home</a> / <span>Dr. Bot</span>
    </div>
    <h1 class="page-title">ğŸ¤– Dr. Bot</h1>
    <p class="page-sub">AI eye health assistant â€” ask anything in English or Tamil</p>
  </div>
</div>

<div class="container chatbot-container">
  <div class="chatbot-layout">

    <!-- Chat Window -->
    <div class="chat-window">
      <div class="chat-header">
        <div class="chat-avatar">ğŸ¤–</div>
        <div class="chat-header-info">
          <strong>Dr. EyeBot</strong>
          <span class="online-dot">â— Online</span>
        </div>
        <div class="lang-switcher">
          <button class="lang-btn active" id="langEn" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ EN</button>
          <button class="lang-btn" id="langTa" onclick="setLang('ta')">ğŸ‡®ğŸ‡³ TA</button>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <!-- Welcome message -->
        <div class="chat-msg bot-msg">
          <div class="msg-avatar">ğŸ¤–</div>
          <div class="msg-bubble">
            <p>Hello! I'm <strong>Dr. EyeBot</strong>, your AI eye health assistant.</p>
            <p>Ask me anything about:</p>
            <ul>
              <li>Eye diseases and symptoms</li>
              <li>Treatments and prevention</li>
              <li>When to see a doctor</li>
            </ul>
            <p><em>à®¨à®¾à®©à¯ à®¤à®®à®¿à®´à®¿à®²à¯à®®à¯ à®ªà¯‡à®šà®²à®¾à®®à¯! TA à®ªà®Ÿà¯à®Ÿà®©à¯ˆ à®…à®´à¯à®¤à¯à®¤à®µà¯à®®à¯.</em></p>
          </div>
        </div>
      </div>

      <!-- Quick Questions -->
      <div class="quick-questions" id="quickQuestions">
        <p class="quick-label">Quick questions:</p>
        <div class="quick-btns">
          <button onclick="sendQuick('What are symptoms of glaucoma?')">Glaucoma symptoms</button>
          <button onclick="sendQuick('How is cataract treated?')">Cataract treatment</button>
          <button onclick="sendQuick('How to prevent eye diseases?')">Prevention tips</button>
          <button onclick="sendQuick('When should I see an eye doctor?')">When to see doctor</button>
        </div>
      </div>

      <div class="chat-input-area">
        <textarea id="chatInput" placeholder="Ask a question about eye health..."
                  rows="1" maxlength="500"></textarea>
        <button id="sendBtn" onclick="sendMessage()">Send â†—</button>
      </div>
      <p class="chat-disclaimer">âš ï¸ Dr. EyeBot is an AI assistant â€” not a replacement for real medical consultation.</p>
    </div>

    <!-- Sidebar Info -->
    <div class="chatbot-sidebar">
      <div class="sidebar-card">
        <h3>ğŸ©º About Dr. EyeBot</h3>
        <p>Powered by GPT-4, trained on ophthalmology knowledge. Responds in English and Tamil.</p>
      </div>
      <div class="sidebar-card">
        <h3>ğŸŒ Language</h3>
        <p>Switch between English and Tamil using the buttons in the chat header.</p>
      </div>
      <div class="sidebar-card">
        <h3>ğŸ’¡ Sample Questions</h3>
        <ul class="sample-questions">
          <li>What causes diabetic retinopathy?</li>
          <li>Is glaucoma hereditary?</li>
          <li>How often should I get eye exams?</li>
          <li>à®•à®£à¯à®ªà¯à®°à¯ˆ à®à®©à¯à®±à®¾à®²à¯ à®à®©à¯à®©?</li>
          <li>à®•à®£à¯ à®†à®°à¯‹à®•à¯à®•à®¿à®¯à®¤à¯à®¤à¯ˆ à®à®ªà¯à®ªà®Ÿà®¿ à®ªà®¾à®¤à¯à®•à®¾à®ªà¯à®ªà®¤à¯?</li>
        </ul>
      </div>
      <div class="sidebar-card sidebar-warning">
        <h3>âš ï¸ Important</h3>
        <p>This chatbot provides general health information only. Always consult a certified ophthalmologist for diagnosis and treatment.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentLang = 'en';
let sessionId = 'sess_' + Math.random().toString(36).substr(2, 9);
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

function setLang(lang) {
  currentLang = lang;
  document.getElementById('langEn').classList.toggle('active', lang === 'en');
  document.getElementById('langTa').classList.toggle('active', lang === 'ta');
  chatInput.placeholder = lang === 'ta'
    ? 'à®•à®£à¯ à®†à®°à¯‹à®•à¯à®•à®¿à®¯à®®à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯...'
    : 'Ask a question about eye health...';
}

function sendQuick(msg) {
  chatInput.value = msg;
  sendMessage();
}

async function sendMessage() {
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatInput.value = '';
  document.getElementById('quickQuestions').style.display = 'none';
  appendMsg(msg, 'user');
  const typing = appendTyping();
  sendBtn.disabled = true;

  try {
    const resp = await fetch("{% url 'chat_api' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, language: currentLang, session_id: sessionId })
    });
    const data = await resp.json();
    typing.remove();
    appendMsg(data.response, 'bot');
    if (data.session_id) sessionId = data.session_id;
  } catch (e) {
    typing.remove();
    appendMsg('Sorry, I could not respond right now. Please try again.', 'bot');
  }
  sendBtn.disabled = false;
}

function appendMsg(text, sender) {
  const div = document.createElement('div');
  div.className = `chat-msg ${sender}-msg`;
  div.innerHTML = sender === 'bot'
    ? `<div class="msg-avatar">ğŸ¤–</div><div class="msg-bubble">${text.replace(/\n/g, '<br>')}</div>`
    : `<div class="msg-bubble user-bubble">${text}</div>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function appendTyping() {
  const div = document.createElement('div');
  div.className = 'chat-msg bot-msg typing-msg';
  div.innerHTML = '<div class="msg-avatar">ğŸ¤–</div><div class="msg-bubble typing-indicator"><span></span><span></span><span></span></div>';
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

// Auto-expand textarea
chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
});
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
</script>
{% endblock %}
